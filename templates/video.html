<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Sala LiveKit</title>
  <!-- M√∫ltiplas fontes do LiveKit para garantir carregamento -->
  <script src="https://cdn.jsdelivr.net/npm/livekit-client@2.5.4/dist/livekit-client.umd.min.js"></script>
  <script>
    // Fallback se o primeiro CDN falhar
    if (typeof LivekitClient === 'undefined') {
      document.write('<script src="https://unpkg.com/livekit-client@2.5.4/dist/livekit-client.umd.min.js"><\/script>');
    }
  </script>
  <style>
    #video-area video { 
      width: 320px; 
      margin: 8px; 
      border-radius: 8px; 
      background: #000;
    }
    #video-area { 
      display: flex; 
      gap: 16px; 
      flex-wrap: wrap;
    }
    #status { 
      margin: 16px 0; 
      color: #444; 
      font-weight: bold; 
      padding: 10px;
      background: #f5f5f5;
      border-radius: 4px;
    }
    .local-video {
      border: 3px solid #007bff !important;
    }
    .remote-video {
      border: 3px solid #28a745 !important;
    }
    button {
      padding: 12px 24px;
      font-size: 16px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>  <h2>Voc√™ entrou na sala: {{.Room}}</h2>
  <div id="status">Aguardando conex√£o...</div>
  <div id="participants-count" style="margin: 8px 0; font-size: 14px; color: #666;">Participantes: 0</div>
  
  <!-- Avisos espec√≠ficos para macOS -->
  <div id="macos-warning" style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; margin: 10px 0; border-radius: 6px;">
    <strong>üçé Instru√ß√µes para macOS:</strong><br>
    1. <strong>Permiss√µes do Sistema:</strong> V√° em Configura√ß√µes ‚Üí Privacidade e Seguran√ßa ‚Üí C√¢mera/Microfone e certifique-se que o seu navegador est√° autorizado<br>
    2. <strong>M√∫ltiplas abas:</strong> Para empregado e m√©dico em abas separadas, permita acesso para cada aba individualmente<br>
    3. <strong>Teste primeiro:</strong> Use o bot√£o "Testar M√≠dia" antes de entrar na chamada
  </div>
  
  <div id="video-area"></div>
  <div id="controls">
    <button id="test-media-btn" style="background: #17a2b8; margin-right: 10px;">üé• Testar M√≠dia</button>
    <button id="join-btn">Entrar na chamada</button>
    <button id="leave-btn" style="display: none; background: #dc3545;">Sair da chamada</button>
  </div>  <div id="debug-info" style="margin-top: 16px; padding: 8px; background: #f0f0f0; border-radius: 4px; font-size: 12px; font-family: monospace; display: block;">
    <strong>Debug:</strong><br>
    <div id="debug-content"></div>
  </div>
  <script>    const status = document.getElementById('status');
    const roomName = "{{.Room}}";
    const livekitHost = window.location.protocol + '//' + window.location.hostname + ':7880';
    let participantCount = 0;
    
    function updateParticipantCount() {
      document.getElementById('participants-count').textContent = `Participantes: ${participantCount}`;
    }
      function addDebugInfo(message) {
      const debugContent = document.getElementById('debug-content');
      const timestamp = new Date().toLocaleTimeString();
      debugContent.innerHTML += `[${timestamp}] ${message}<br>`;
      document.getElementById('debug-info').style.display = 'block';
    }    // Adiciona informa√ß√µes iniciais de debug
    addDebugInfo(`P√°gina carregada. Sala: ${roomName}`);
    addDebugInfo(`LiveKit Host: ${livekitHost}`);
    addDebugInfo(`User Agent: ${navigator.userAgent}`);
    
    // Aguarda carregamento do LiveKit e faz verifica√ß√µes
    setTimeout(() => {
      addDebugInfo(`LivekitClient carregado: ${typeof LivekitClient !== 'undefined' ? 'Sim' : 'N√£o'}`);
      if (typeof LivekitClient !== 'undefined') {
        addDebugInfo(`LivekitClient.Room dispon√≠vel: ${typeof LivekitClient.Room !== 'undefined' ? 'Sim' : 'N√£o'}`);
      } else {
        addDebugInfo('‚ùå PROBLEMA CR√çTICO: LiveKit Client SDK n√£o carregou!');
        addDebugInfo('Poss√≠veis solu√ß√µes: Verificar conex√£o, desabilitar bloqueadores, tentar modo inc√≥gnito');
        updateStatus('‚ùå Erro: LiveKit SDK n√£o carregou. Verifique sua conex√£o com internet.');
      }
    }, 1000);
    
    function updateStatus(message) {
      status.textContent = message;
      console.log('Status:', message);
      addDebugInfo(message);
    }
      async function fetchToken(identity) {
      updateStatus('Solicitando token...');
      addDebugInfo(`Solicitando token para identidade: ${identity}, sala: ${roomName}`);
      const resp = await fetch(`/api/token?room=${roomName}&identity=${identity}`);
      if (!resp.ok) {
        addDebugInfo(`Erro HTTP: ${resp.status} ${resp.statusText}`);
        throw new Error('Erro ao obter token do servidor');
      }
      const data = await resp.json();
      addDebugInfo(`Token recebido: ${data.token.substring(0, 50)}...`);
      return data.token;
    }
      function addVideoElement(track, participant, isLocal = false) {
      const el = track.attach();
      el.style.width = '320px';
      el.style.margin = '8px';
      el.style.borderRadius = '8px';
      el.className = isLocal ? 'local-video' : 'remote-video';
      el.setAttribute('data-participant', participant.identity);
      
      // Adiciona label para identificar o v√≠deo
      const container = document.createElement('div');
      container.style.position = 'relative';
      container.style.display = 'inline-block';
      
      const label = document.createElement('div');
      label.textContent = isLocal ? 'Voc√™' : participant.identity;
      label.style.position = 'absolute';
      label.style.bottom = '8px';
      label.style.left = '8px';
      label.style.background = 'rgba(0,0,0,0.7)';
      label.style.color = 'white';
      label.style.padding = '4px 8px';
      label.style.borderRadius = '4px';
      label.style.fontSize = '12px';
      
      container.appendChild(el);
      container.appendChild(label);
      document.getElementById('video-area').appendChild(container);
      
      if (isLocal) {
        updateStatus('‚úÖ Seu v√≠deo est√° ativo! Aguardando outros participantes...');
      } else {
        updateStatus(`‚úÖ V√≠deo de ${participant.identity} conectado!`);
      }
    }      document.getElementById('join-btn').onclick = async () => {
      // Gera identidade √∫nica baseada no tipo de usu√°rio e timestamp
      const userType = roomName.includes('empregado-') ? 'empregado' : 'medico';
      const identity = userType + '-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
        try {
        // Verifica√ß√£o pr√©via do LiveKit
        if (typeof LivekitClient === 'undefined') {
          throw new Error('LiveKit Client SDK n√£o carregou. Recarregue a p√°gina ou verifique sua conex√£o com internet.');
        }
        
        updateStatus('üîê Verificando permiss√µes de m√≠dia...');
        
        // Primeiro, verifica se as permiss√µes j√° foram concedidas
        const permissions = await navigator.mediaDevices.getUserMedia({
          video: true,
          audio: true
        }).catch(err => {
          console.error('Erro de permiss√£o inicial:', err);
          throw err;
        });
        
        // Se chegou aqui, as permiss√µes foram concedidas
        updateStatus('‚úÖ Permiss√µes concedidas! Conectando √† sala...');
        
        const token = await fetchToken(identity);
        
        const room = new LivekitClient.Room({
          adaptiveStream: true,
          dynacast: true,
        });
        
        // Configura eventos antes da conex√£o
        room.on(LivekitClient.RoomEvent.TrackSubscribed, (track, publication, participant) => {
          console.log('Track subscribed:', track.kind, 'from', participant.identity);
          if (track.kind === 'video') {
            addVideoElement(track, participant, false);
          }
        });
        
        room.on(LivekitClient.RoomEvent.TrackUnsubscribed, (track, publication, participant) => {
          console.log('Track unsubscribed:', track.kind, 'from', participant.identity);
          track.detach().forEach(el => el.remove());
        });
        
        room.on(LivekitClient.RoomEvent.LocalTrackPublished, (publication, participant) => {
          console.log('Local track published:', publication.kind);
          if (publication.kind === 'video') {
            updateStatus('Seu v√≠deo foi publicado!');
          }
        });
          room.on(LivekitClient.RoomEvent.ParticipantConnected, (participant) => {
          console.log('Participant connected:', participant.identity);
          participantCount++;
          updateParticipantCount();
          updateStatus(`${participant.identity} entrou na sala!`);
        });        room.on(LivekitClient.RoomEvent.ParticipantDisconnected, (participant) => {
          console.log('Participant disconnected:', participant.identity);
          participantCount--;
          updateParticipantCount();
          // Remove v√≠deos do participante
          const videos = document.querySelectorAll(`[data-participant="${participant.identity}"]`);
          videos.forEach(video => {
            // Remove o container pai se existir
            const container = video.parentElement;
            if (container && container.parentElement) {
              container.parentElement.removeChild(container);
            } else {
              video.remove();
            }
          });
          updateStatus(`${participant.identity} saiu da sala.`);
        });
        
        room.on(LivekitClient.RoomEvent.Disconnected, () => {
          updateStatus('Desconectado da sala.');
        });        // Conecta √† sala
        addDebugInfo(`Tentando conectar ao LiveKit: ${livekitHost}`);
        await room.connect(livekitHost, token);
        addDebugInfo('Conex√£o com LiveKit estabelecida!');
        updateStatus('Conectado! Ativando c√¢mera e microfone...');
        
        // Conta o participante local
        participantCount = room.remoteParticipants.size + 1; // +1 para o participante local
        updateParticipantCount();
        
        document.getElementById('join-btn').style.display = 'none';
        document.getElementById('leave-btn').style.display = 'inline-block';
          // Cria e publica tracks de v√≠deo e √°udio
        try {
          updateStatus('Solicitando permiss√µes de c√¢mera e microfone...');
            // Configura√ß√µes otimizadas para desenvolvimento local e m√∫ltiplas abas
          const videoTrack = await LivekitClient.createLocalVideoTrack({
            resolution: LivekitClient.VideoPresets.h540.resolution, // Resolu√ß√£o menor para melhor performance
            deviceId: undefined, // Deixa o browser escolher a c√¢mera padr√£o
            facingMode: 'user', // C√¢mera frontal por padr√£o
          });
          
          const audioTrack = await LivekitClient.createLocalAudioTrack({
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true, // Adiciona controle autom√°tico de ganho
            deviceId: undefined, // Deixa o browser escolher o microfone padr√£o
          });
          
          updateStatus('Publicando v√≠deo e √°udio...');
          
          // Publica as tracks
          await room.localParticipant.publishTrack(videoTrack, {
            name: `${identity}-video`,
            source: LivekitClient.Track.Source.Camera,
          });
          
          await room.localParticipant.publishTrack(audioTrack, {
            name: `${identity}-audio`, 
            source: LivekitClient.Track.Source.Microphone,
          });
          
          // Exibe o v√≠deo local imediatamente
          addVideoElement(videoTrack, room.localParticipant, true);
          
          updateStatus('V√≠deo e √°udio publicados! Voc√™ est√° online na sala.');
          
        } catch (mediaError) {
          console.error('Erro ao acessar m√≠dia:', mediaError);
            // Mensagens de erro mais espec√≠ficas
          if (mediaError.name === 'NotAllowedError') {
            updateStatus('‚ùå Permiss√£o negada para c√¢mera/microfone. Clique no √≠cone da c√¢mera na barra de endere√ßos e permita o acesso. Para m√∫ltiplas abas, permita para cada aba separadamente.');
          } else if (mediaError.name === 'NotFoundError') {
            updateStatus('‚ùå C√¢mera ou microfone n√£o encontrados. Verifique se est√£o conectados.');
          } else if (mediaError.name === 'NotReadableError') {
            updateStatus('‚ùå C√¢mera/microfone em uso por outro aplicativo. Feche outros programas de v√≠deo ou use abas diferentes para empregado e m√©dico.');
          } else if (mediaError.name === 'AbortError') {
            updateStatus('‚ùå Acesso √† m√≠dia foi interrompido. Tente novamente.');
          } else {
            updateStatus('‚ùå Erro ao acessar m√≠dia: ' + mediaError.message + ' (Tipo: ' + mediaError.name + ')');
          }
        }      } catch (error) {
        console.error('Erro geral:', error);
        addDebugInfo(`Erro geral: ${error.name} - ${error.message}`);
        
        let errorMsg = 'Erro: ';
        if (error.message.includes('token')) {
          errorMsg += 'Falha ao obter token de autentica√ß√£o. Verifique se o backend est√° funcionando.';
        } else if (error.message.includes('connect') || error.message.includes('WebSocket')) {
          errorMsg += 'Falha ao conectar com o servidor LiveKit. Verifique se o LiveKit est√° rodando na porta 7880.';
        } else {
          errorMsg += error.message;
        }
        
        updateStatus(errorMsg);
        
        // Mostra bot√£o para tentar novamente
        document.getElementById('join-btn').style.display = 'inline-block';
        document.getElementById('leave-btn').style.display = 'none';
      }
    };    // Funcionalidade de teste de m√≠dia
    document.getElementById('test-media-btn').onclick = async () => {
      try {
        updateStatus('üß™ Testando acesso √† c√¢mera e microfone...');
        
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { 
            width: { ideal: 1280 },
            height: { ideal: 720 },
            facingMode: 'user'
          },
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          }
        });
        
        // Cria um elemento de v√≠deo de teste
        const testVideo = document.createElement('video');
        testVideo.srcObject = stream;
        testVideo.autoplay = true;
        testVideo.muted = true; // Evita feedback de √°udio
        testVideo.style.width = '320px';
        testVideo.style.border = '2px solid #28a745';
        testVideo.style.borderRadius = '8px';
        testVideo.style.margin = '10px';
        
        const testContainer = document.createElement('div');
        testContainer.id = 'test-container';
        testContainer.style.textAlign = 'center';
        
        const testLabel = document.createElement('div');
        testLabel.textContent = '‚úÖ Teste de M√≠dia - Voc√™ deveria se ver aqui';
        testLabel.style.color = '#28a745';
        testLabel.style.fontWeight = 'bold';
        testLabel.style.margin = '10px';
        
        const stopTestBtn = document.createElement('button');
        stopTestBtn.textContent = '‚èπÔ∏è Parar Teste';
        stopTestBtn.style.background = '#dc3545';
        stopTestBtn.style.margin = '10px';
        stopTestBtn.onclick = () => {
          stream.getTracks().forEach(track => track.stop());
          testContainer.remove();
          updateStatus('Teste finalizado. Agora voc√™ pode entrar na chamada.');
        };
        
        testContainer.appendChild(testLabel);
        testContainer.appendChild(testVideo);
        testContainer.appendChild(stopTestBtn);
        
        document.getElementById('video-area').appendChild(testContainer);
        
        updateStatus('‚úÖ Teste bem-sucedido! C√¢mera e microfone funcionando. Voc√™ pode entrar na chamada.');
        
      } catch (error) {
        console.error('Erro no teste de m√≠dia:', error);
        
        let errorMsg = '‚ùå Teste de m√≠dia falhou: ';
        if (error.name === 'NotAllowedError') {
          errorMsg += 'Permiss√£o negada. No macOS, v√° em Safari ‚Üí Prefer√™ncias ‚Üí Sites ‚Üí C√¢mera/Microfone e permita para este site.';
        } else if (error.name === 'NotFoundError') {
          errorMsg += 'C√¢mera/microfone n√£o encontrados. Verifique as conex√µes.';
        } else if (error.name === 'NotReadableError') {
          errorMsg += 'C√¢mera/microfone em uso por outro app. Feche outros programas de v√≠deo.';
        } else {
          errorMsg += `${error.message} (Tipo: ${error.name})`;
        }
        
        updateStatus(errorMsg);
      }
    };

    // Funcionalidade de sair da chamada
    document.getElementById('leave-btn').onclick = function() {
      updateStatus('Saindo da chamada...');
      location.reload(); // Recarrega a p√°gina para permitir nova conex√£o
    };
  </script>
</body>
</html>
