<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Teste LiveKit B√°sico</title>
  <!-- M√∫ltiplas fontes do LiveKit para garantir carregamento -->
  <script src="https://cdn.jsdelivr.net/npm/livekit-client@2.5.4/dist/livekit-client.umd.min.js"></script>
  <script>
    // Fallback se o primeiro CDN falhar
    if (typeof LivekitClient === 'undefined') {
      document.write('<script src="https://unpkg.com/livekit-client@2.5.4/dist/livekit-client.umd.min.js"><\/script>');
    }
  </script>
</head>
<body>
  <h1>üß™ Teste LiveKit B√°sico</h1>
  <div id="status">Carregando...</div>
  <div id="debug"></div>
  <button id="test-btn">Testar Conex√£o LiveKit</button>
  <div id="video-area"></div>

  <script>
    const debug = document.getElementById('debug');
    const status = document.getElementById('status');
    
    function log(message) {
      const timestamp = new Date().toLocaleTimeString();
      debug.innerHTML += `[${timestamp}] ${message}<br>`;
      console.log(message);
    }
    
    // Aguarda um pouco para garantir que todos os scripts carregaram
    setTimeout(() => {
      // Verifica√ß√µes iniciais
      log(`LivekitClient carregado: ${typeof LivekitClient !== 'undefined'}`);
      
      if (typeof LivekitClient === 'undefined') {
        log('‚ùå PROBLEMA: LiveKit Client SDK n√£o carregou!');
        log('Tentando carregar manualmente...');
        
        // Tentativa manual de carregamento
        const script = document.createElement('script');
        script.src = 'https://cdn.skypack.dev/livekit-client@2.5.4';
        script.onload = () => {
          log('‚úÖ LiveKit carregado via Skypack!');
          checkLiveKitAgain();
        };
        script.onerror = () => {
          log('‚ùå Falha ao carregar via Skypack tamb√©m');
          showCDNTroubleshooting();
        };
        document.head.appendChild(script);
      } else {
        checkLiveKitCapabilities();
      }
    }, 1000);
    
    function checkLiveKitAgain() {
      if (typeof LivekitClient !== 'undefined') {
        log(`‚úÖ LiveKit agora dispon√≠vel!`);
        checkLiveKitCapabilities();
      } else {
        log('‚ùå LiveKit ainda n√£o dispon√≠vel');
        showCDNTroubleshooting();
      }
    }
    
    function checkLiveKitCapabilities() {
      if (typeof LivekitClient.Room !== 'undefined') {
        log(`‚úÖ LivekitClient.Room dispon√≠vel`);
      }
      if (typeof LivekitClient.createLocalVideoTrack !== 'undefined') {
        log(`‚úÖ LivekitClient.createLocalVideoTrack dispon√≠vel`);
      }
      status.textContent = 'Pronto para teste';
    }
    
    function showCDNTroubleshooting() {
      status.textContent = '‚ùå Erro: LiveKit SDK n√£o carregou';
      log('üîß SOLU√á√ïES POSS√çVEIS:');
      log('1. Verificar conex√£o com internet');
      log('2. Desabilitar bloqueadores de an√∫ncio/script');
      log('3. Tentar em modo inc√≥gnito');
      log('4. Verificar se empresa bloqueia CDNs externos');
      
      // Adiciona bot√£o para tentar recarregar
      const reloadBtn = document.createElement('button');
      reloadBtn.textContent = 'üîÑ Recarregar P√°gina';
      reloadBtn.style.background = '#dc3545';
      reloadBtn.style.marginTop = '10px';
      reloadBtn.onclick = () => location.reload();
      document.body.appendChild(reloadBtn);
    }
    
    document.getElementById('test-btn').onclick = async () => {
      try {
        log('Iniciando teste...');
        status.textContent = 'Testando...';
        
        // Log WebRTC debug info
        log('üì° UserAgent: ' + navigator.userAgent);
        const rtcPeerConn = window.RTCPeerConnection || window.webkitRTCPeerConnection;
        log('üì° RTCPeerConnection dispon√≠vel: ' + (rtcPeerConn ? '‚úÖ' : '‚ùå'));
        
        // Verifica√ß√£o pr√©via
        if (typeof LivekitClient === 'undefined') {
          throw new Error('LiveKit Client SDK n√£o est√° carregado. Verifique sua conex√£o com internet ou bloqueadores de script.');
        }
        
        // Teste 1: Verificar se consegue criar room
        log('Teste 1: Criando Room...');
        const room = new LivekitClient.Room();
        log('‚úÖ Room criada com sucesso');
        
        // Teste 2: Verificar se consegue pegar token
        log('Teste 2: Solicitando token...');
        const resp = await fetch('/token?room=test&identity=test-user');
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        log('‚úÖ Token recebido');
        
        // Teste 3: Tentar conectar
        log('Teste 3: Conectando ao LiveKit...');
        await room.connect('http://localhost:7880', data.token);
        log('‚úÖ Conectado ao LiveKit!');
        
        // Teste 4: Verificar permiss√µes de m√≠dia
        log('Teste 4: Testando permiss√µes de m√≠dia...');
        const stream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
        log('‚úÖ Permiss√µes de m√≠dia OK');
        
        // Teste 5: Criar video track
        log('Teste 5: Criando video track...');
        const videoTrack = await LivekitClient.createLocalVideoTrack();
        log('‚úÖ Video track criado');
        
        // Teste 6: Exibir v√≠deo
        log('Teste 6: Exibindo v√≠deo...');
        const videoElement = videoTrack.attach();
        videoElement.style.width = '320px';
        videoElement.style.border = '2px solid green';
        document.getElementById('video-area').appendChild(videoElement);
        log('‚úÖ V√≠deo exibido!');
        
        status.textContent = '‚úÖ Todos os testes passaram!';
        
      } catch (error) {
        log(`‚ùå Erro: ${error.name} - ${error.message}`);
        status.textContent = `‚ùå Falha no teste: ${error.message}`;
        
        // Diagn√≥stico espec√≠fico
        if (error.message.includes('LiveKit Client SDK')) {
          log('üîß SOLU√á√ÉO: Problema de carregamento do SDK');
          log('   - Verifique sua conex√£o com internet');
          log('   - Desabilite bloqueadores de an√∫ncio');
          log('   - Tente em modo inc√≥gnito');
        }
      }
    };
  </script>
</body>
</html>
