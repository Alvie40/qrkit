<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QRKit - Teste Completo</title>
  <script src="https://cdn.jsdelivr.net/npm/livekit-client@2.5.4/dist/livekit-client.umd.min.js"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px; 
      background-color: #f5f5f5; 
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #f9f9f9;
    }
    .success { border-color: #28a745; background: #d4edda; }
    .error { border-color: #dc3545; background: #f8d7da; }
    .warning { border-color: #ffc107; background: #fff3cd; }
    button {
      padding: 10px 20px;
      margin: 5px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background: #0056b3; }
    button:disabled { background: #6c757d; cursor: not-allowed; }
    #log {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ QRKit - Teste Completo de Conectividade</h1>
    
    <div class="test-section" id="basic-tests">
      <h3>1. Testes B√°sicos</h3>
      <button onclick="testBasicConnectivity()">Testar Conectividade B√°sica</button>
      <button onclick="testLiveKitSDK()">Testar LiveKit SDK</button>
      <div id="basic-results"></div>
    </div>

    <div class="test-section" id="webrtc-tests">
      <h3>2. Testes WebRTC</h3>
      <button onclick="testMediaDevices()">Testar C√¢mera/Microfone</button>
      <button onclick="testSTUNConnectivity()">Testar STUN Servers</button>
      <div id="webrtc-results"></div>
    </div>

    <div class="test-section" id="livekit-tests">
      <h3>3. Testes LiveKit</h3>
      <button onclick="testLiveKitConnection()">Testar Conex√£o LiveKit</button>
      <button onclick="testTokenGeneration()">Testar Gera√ß√£o de Token</button>
      <div id="livekit-results"></div>
    </div>

    <div class="test-section" id="full-test">
      <h3>4. Teste Completo</h3>
      <button onclick="runFullTest()" style="background: #28a745;">üöÄ Executar Teste Completo</button>
      <div id="full-results"></div>
    </div>

    <div class="test-section">
      <h3>üìù Log de Testes</h3>
      <div id="log"></div>
      <button onclick="clearLog()" style="background: #6c757d;">Limpar Log</button>
    </div>
  </div>

  <script>
    const livekitHost = window.location.protocol + '//' + window.location.hostname + ':7880';
    
    function log(message) {
      const timestamp = new Date().toLocaleTimeString();
      document.getElementById('log').textContent += `[${timestamp}] ${message}\n`;
      document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
      console.log(message);
    }

    function clearLog() {
      document.getElementById('log').textContent = '';
    }

    function showResult(elementId, message, type = 'success') {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="${type}">${message}</div>`;
    }

    async function testBasicConnectivity() {
      log('Iniciando teste de conectividade b√°sica...');
      try {
        const response = await fetch('/');
        if (response.ok) {
          log('‚úÖ Servidor QRKit acess√≠vel');
          showResult('basic-results', '‚úÖ Servidor QRKit OK', 'success');
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (error) {
        log(`‚ùå Erro na conectividade b√°sica: ${error.message}`);
        showResult('basic-results', `‚ùå Erro: ${error.message}`, 'error');
      }
    }

    async function testLiveKitSDK() {
      log('Testando carregamento do LiveKit SDK...');
      if (typeof LivekitClient !== 'undefined') {
        log('‚úÖ LiveKit SDK carregado com sucesso');
        log(`Vers√£o: ${LivekitClient.version || 'Desconhecida'}`);
        showResult('basic-results', '‚úÖ LiveKit SDK OK', 'success');
      } else {
        log('‚ùå LiveKit SDK n√£o carregou');
        showResult('basic-results', '‚ùå LiveKit SDK n√£o carregado', 'error');
      }
    }

    async function testMediaDevices() {
      log('Testando acesso a dispositivos de m√≠dia...');
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: true, 
          audio: true 
        });
        log('‚úÖ Acesso √† c√¢mera e microfone concedido');
        log(`Tracks de v√≠deo: ${stream.getVideoTracks().length}`);
        log(`Tracks de √°udio: ${stream.getAudioTracks().length}`);
        
        // Para o stream
        stream.getTracks().forEach(track => track.stop());
        showResult('webrtc-results', '‚úÖ C√¢mera/Microfone OK', 'success');
      } catch (error) {
        log(`‚ùå Erro no acesso √† m√≠dia: ${error.name} - ${error.message}`);
        showResult('webrtc-results', `‚ùå M√≠dia: ${error.name}`, 'error');
      }
    }

    async function testSTUNConnectivity() {
      log('Testando conectividade STUN...');
      try {
        const pc = new RTCPeerConnection({
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
          ]
        });

        return new Promise((resolve) => {
          let resolved = false;
          const timeout = setTimeout(() => {
            if (!resolved) {
              resolved = true;
              log('‚ö†Ô∏è Timeout na conex√£o STUN');
              showResult('webrtc-results', '‚ö†Ô∏è STUN timeout', 'warning');
              resolve();
            }
          }, 5000);

          pc.onicecandidate = (event) => {
            if (event.candidate && !resolved) {
              resolved = true;
              clearTimeout(timeout);
              log(`‚úÖ Candidato ICE obtido: ${event.candidate.candidate}`);
              showResult('webrtc-results', '‚úÖ STUN OK', 'success');
              pc.close();
              resolve();
            }
          };

          pc.createDataChannel('test');
          pc.createOffer().then(offer => pc.setLocalDescription(offer));
        });
      } catch (error) {
        log(`‚ùå Erro no teste STUN: ${error.message}`);
        showResult('webrtc-results', `‚ùå STUN: ${error.message}`, 'error');
      }
    }

    async function testLiveKitConnection() {
      log('Testando conex√£o com LiveKit server...');
      try {
        const response = await fetch(livekitHost);
        if (response.ok) {
          const text = await response.text();
          log(`‚úÖ LiveKit server respondeu: ${text}`);
          showResult('livekit-results', '‚úÖ LiveKit Server OK', 'success');
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (error) {
        log(`‚ùå Erro na conex√£o LiveKit: ${error.message}`);
        showResult('livekit-results', `‚ùå LiveKit: ${error.message}`, 'error');
      }
    }

    async function testTokenGeneration() {
      log('Testando gera√ß√£o de token...');
      try {
        const response = await fetch(`/api/token?room=test-room&identity=test-user`);
        if (response.ok) {
          const data = await response.json();
          if (data.token) {
            log('‚úÖ Token gerado com sucesso');
            log(`Token (primeiros 50 chars): ${data.token.substring(0, 50)}...`);
            showResult('livekit-results', '‚úÖ Token OK', 'success');
          } else {
            throw new Error('Token n√£o encontrado na resposta');
          }
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (error) {
        log(`‚ùå Erro na gera√ß√£o de token: ${error.message}`);
        showResult('livekit-results', `‚ùå Token: ${error.message}`, 'error');
      }
    }

    async function runFullTest() {
      log('üöÄ Iniciando teste completo...');
      showResult('full-results', '‚è≥ Executando testes...', 'warning');
      
      const tests = [
        testBasicConnectivity,
        testLiveKitSDK,
        testMediaDevices,
        testSTUNConnectivity,
        testLiveKitConnection,
        testTokenGeneration
      ];

      let passed = 0;
      let failed = 0;

      for (const test of tests) {
        try {
          await test();
          passed++;
        } catch (error) {
          failed++;
          log(`‚ùå Teste falhou: ${error.message}`);
        }
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      const total = passed + failed;
      const percentage = Math.round((passed / total) * 100);
      
      if (percentage >= 80) {
        log(`üéâ Teste completo finalizado: ${passed}/${total} (${percentage}%) - SUCESSO`);
        showResult('full-results', `üéâ ${passed}/${total} testes passaram (${percentage}%)`, 'success');
      } else {
        log(`‚ö†Ô∏è Teste completo finalizado: ${passed}/${total} (${percentage}%) - PROBLEMAS DETECTADOS`);
        showResult('full-results', `‚ö†Ô∏è ${passed}/${total} testes passaram (${percentage}%)`, 'warning');
      }
    }

    // Testa automaticamente quando a p√°gina carrega
    window.onload = () => {
      log('P√°gina carregada. Pronto para testes.');
      testBasicConnectivity();
      testLiveKitSDK();
    };
  </script>
</body>
</html>
