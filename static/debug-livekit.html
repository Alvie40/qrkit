<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>üîç Debug LiveKit - QRKit</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px; 
      background: #f5f5f5; 
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #f9f9f9;
    }
    .success { border-color: #28a745; background: #d4edda; }
    .error { border-color: #dc3545; background: #f8d7da; }
    .warning { border-color: #ffc107; background: #fff3cd; }
    button {
      padding: 10px 20px;
      margin: 5px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #007bff;
      color: white;
    }
    button:hover { background: #0056b3; }
    #debug-log {
      background: #000;
      color: #0f0;
      padding: 15px;
      font-family: monospace;
      font-size: 12px;
      border-radius: 4px;
      height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Debug LiveKit - QRKit</h1>
    <p>Esta p√°gina testa cada componente do sistema passo a passo.</p>

    <div class="test-section" id="section-1">
      <h3>1Ô∏è‚É£ Teste de Carregamento do LiveKit SDK</h3>
      <p>Verificando se a biblioteca LiveKit foi carregada corretamente...</p>
      <button onclick="testLibraryLoad()">üîÑ Testar Carregamento</button>
      <div id="result-1"></div>
    </div>

    <div class="test-section" id="section-2">
      <h3>2Ô∏è‚É£ Teste de Conectividade com Backend</h3>
      <p>Verificando se consegue obter token do backend...</p>
      <button onclick="testBackendConnection()">üîÑ Testar Backend</button>
      <div id="result-2"></div>
    </div>

    <div class="test-section" id="section-3">
      <h3>3Ô∏è‚É£ Teste de Permiss√µes de M√≠dia</h3>
      <p>Verificando acesso √† c√¢mera e microfone...</p>
      <button onclick="testMediaPermissions()">üîÑ Testar M√≠dia</button>
      <div id="result-3"></div>
    </div>

    <div class="test-section" id="section-4">
      <h3>4Ô∏è‚É£ Teste de Conex√£o LiveKit</h3>
      <p>Tentando conectar ao servidor LiveKit...</p>
      <button onclick="testLiveKitConnection()" id="test-livekit-btn" disabled>üîÑ Testar LiveKit</button>
      <div id="result-4"></div>
    </div>

    <div class="test-section" id="section-5">
      <h3>5Ô∏è‚É£ Teste Completo de V√≠deo</h3>
      <p>Teste final: v√≠deo funcionando...</p>
      <button onclick="testCompleteVideo()" id="test-video-btn" disabled>üîÑ Testar V√≠deo</button>
      <div id="result-5"></div>
      <div id="video-container"></div>
    </div>

    <div class="test-section">
      <h3>üìã Log de Debug</h3>
      <div id="debug-log"></div>
      <button onclick="clearLog()">üóëÔ∏è Limpar Log</button>
    </div>
  </div>

  <!-- Carregamento do LiveKit SDK -->
  <script src="https://unpkg.com/livekit-client@2.5.4/dist/livekit-client.umd.min.js"></script>
  
  <script>
    let currentToken = null;
    let currentRoom = null;

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logElement = document.getElementById('debug-log');
      const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
      logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
      logElement.scrollTop = logElement.scrollHeight;
      console.log(`[${type.toUpperCase()}]`, message);
    }

    function clearLog() {
      document.getElementById('debug-log').textContent = '';
    }

    function updateResult(sectionNum, message, success = null) {
      const resultDiv = document.getElementById(`result-${sectionNum}`);
      const section = document.getElementById(`section-${sectionNum}`);
      
      resultDiv.innerHTML = `<p>${message}</p>`;
      
      if (success === true) {
        section.className = 'test-section success';
      } else if (success === false) {
        section.className = 'test-section error';
      } else {
        section.className = 'test-section warning';
      }
    }

    // Teste 1: Carregamento da biblioteca
    function testLibraryLoad() {
      log('Iniciando teste de carregamento da biblioteca...');
      
      try {
        if (typeof LivekitClient === 'undefined') {
          throw new Error('LivekitClient n√£o est√° definido');
        }
        
        log('LivekitClient est√° dispon√≠vel');
        
        if (typeof LivekitClient.Room === 'undefined') {
          throw new Error('LivekitClient.Room n√£o est√° dispon√≠vel');
        }
        
        log('LivekitClient.Room est√° dispon√≠vel');
        
        if (typeof LivekitClient.createLocalVideoTrack === 'undefined') {
          throw new Error('LivekitClient.createLocalVideoTrack n√£o est√° dispon√≠vel');
        }
        
        log('LivekitClient.createLocalVideoTrack est√° dispon√≠vel');
        
        updateResult(1, '‚úÖ LiveKit SDK carregado com sucesso!', true);
        document.getElementById('test-livekit-btn').disabled = false;
        log('Teste de carregamento: SUCESSO', 'success');
        
      } catch (error) {
        updateResult(1, `‚ùå Erro no carregamento: ${error.message}`, false);
        log(`Erro no carregamento da biblioteca: ${error.message}`, 'error');
      }
    }

    // Teste 2: Conectividade com backend
    async function testBackendConnection() {
      log('Iniciando teste de conectividade com backend...');
      
      try {
        const response = await fetch('/token?room=test&identity=debug-user');
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.token) {
          throw new Error('Token n√£o recebido do servidor');
        }
        
        currentToken = data.token;
        log(`Token recebido: ${data.token.substring(0, 50)}...`);
        
        updateResult(2, '‚úÖ Backend respondendo corretamente!', true);
        log('Teste de backend: SUCESSO', 'success');
        
      } catch (error) {
        updateResult(2, `‚ùå Erro no backend: ${error.message}`, false);
        log(`Erro na conectividade com backend: ${error.message}`, 'error');
      }
    }

    // Teste 3: Permiss√µes de m√≠dia
    async function testMediaPermissions() {
      log('Iniciando teste de permiss√µes de m√≠dia...');
      
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { 
            width: { ideal: 640 },
            height: { ideal: 480 },
            facingMode: 'user'
          },
          audio: {
            echoCancellation: true,
            noiseSuppression: true
          }
        });
        
        log(`Stream obtido com ${stream.getVideoTracks().length} track(s) de v√≠deo e ${stream.getAudioTracks().length} track(s) de √°udio`);
        
        // Para o stream para n√£o manter a c√¢mera ocupada
        stream.getTracks().forEach(track => track.stop());
        
        updateResult(3, '‚úÖ Permiss√µes de m√≠dia concedidas!', true);
        log('Teste de permiss√µes: SUCESSO', 'success');
        
      } catch (error) {
        let errorMsg = `Erro: ${error.name} - ${error.message}`;
        
        if (error.name === 'NotAllowedError') {
          errorMsg += '\nüí° Solu√ß√£o: Permita acesso √† c√¢mera/microfone nas configura√ß√µes do navegador';
        } else if (error.name === 'NotFoundError') {
          errorMsg += '\nüí° Solu√ß√£o: Verifique se c√¢mera/microfone est√£o conectados';
        }
        
        updateResult(3, `‚ùå ${errorMsg}`, false);
        log(`Erro nas permiss√µes de m√≠dia: ${error.name} - ${error.message}`, 'error');
      }
    }

    // Teste 4: Conex√£o LiveKit
    async function testLiveKitConnection() {
      log('Iniciando teste de conex√£o LiveKit...');
      
      if (!currentToken) {
        updateResult(4, '‚ùå Execute primeiro o teste de backend para obter token', false);
        return;
      }
      
      try {
        const room = new LivekitClient.Room();
        log('Room criada');
        
        // Configurar eventos para debug
        room.on(LivekitClient.RoomEvent.Connected, () => {
          log('Evento: Connected');
        });
        
        room.on(LivekitClient.RoomEvent.Disconnected, () => {
          log('Evento: Disconnected');
        });
        
        room.on(LivekitClient.RoomEvent.ConnectionStateChanged, (state) => {
          log(`Evento: ConnectionStateChanged - ${state}`);
        });
        
        log('Tentando conectar ao LiveKit...');
        await room.connect('http://localhost:7880', currentToken);
        log('Conex√£o estabelecida com sucesso!');
        
        currentRoom = room;
        updateResult(4, '‚úÖ Conectado ao LiveKit!', true);
        document.getElementById('test-video-btn').disabled = false;
        log('Teste de conex√£o LiveKit: SUCESSO', 'success');
        
      } catch (error) {
        updateResult(4, `‚ùå Erro na conex√£o LiveKit: ${error.message}`, false);
        log(`Erro na conex√£o LiveKit: ${error.message}`, 'error');
        log(`Stack trace: ${error.stack}`, 'error');
      }
    }

    // Teste 5: V√≠deo completo
    async function testCompleteVideo() {
      log('Iniciando teste completo de v√≠deo...');
      
      if (!currentRoom) {
        updateResult(5, '‚ùå Execute primeiro o teste de conex√£o LiveKit', false);
        return;
      }
      
      try {
        log('Criando track de v√≠deo...');
        const videoTrack = await LivekitClient.createLocalVideoTrack({
          resolution: LivekitClient.VideoPresets.h540.resolution,
          facingMode: 'user'
        });
        
        log('Track de v√≠deo criado');
        
        log('Publicando track...');
        await currentRoom.localParticipant.publishTrack(videoTrack);
        log('Track publicado');
        
        log('Criando elemento de v√≠deo...');
        const videoElement = videoTrack.attach();
        videoElement.style.width = '320px';
        videoElement.style.border = '3px solid #28a745';
        videoElement.style.borderRadius = '8px';
        videoElement.style.margin = '10px';
        
        const container = document.getElementById('video-container');
        container.innerHTML = '<h4>üé• Seu V√≠deo:</h4>';
        container.appendChild(videoElement);
        
        updateResult(5, '‚úÖ V√≠deo funcionando perfeitamente!', true);
        log('Teste completo de v√≠deo: SUCESSO', 'success');
        
      } catch (error) {
        updateResult(5, `‚ùå Erro no teste de v√≠deo: ${error.message}`, false);
        log(`Erro no teste de v√≠deo: ${error.message}`, 'error');
      }
    }

    // Executa o primeiro teste automaticamente
    window.onload = function() {
      log('P√°gina carregada. Iniciando diagn√≥sticos...', 'info');
      log(`User Agent: ${navigator.userAgent}`);
      setTimeout(testLibraryLoad, 500); // Pequena pausa para garantir que tudo carregou
    };
  </script>
</body>
</html>
